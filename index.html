<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparativo: Consertar vs Comprar Ferramentas</title>
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0c10;
            padding: 20px;
            min-height: 100vh;
            color: #e1e9f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1a1f2b;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #2d3748;
        }

        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e1e9f0;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #2d3748;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #60a5fa;
        }

        .header p {
            font-size: 16px;
            opacity: 0.8;
            color: #94a3b8;
        }

        .logos-box {
            background: #0f172a;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 30px;
            border-bottom: 1px solid #2d3748;
        }

        .logo-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .logo-fw,
        .logo-delservin,
        .logo-altercon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .logo-fw {
            background: #3b82f6;
        }

        .logo-delservin {
            background: #059669;
        }

        .logo-altercon {
            background: #d97706;
        }

        .filters {
            padding: 20px;
            background: #111827;
            border-bottom: 1px solid #2d3748;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: bold;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            color: #e1e9f0;
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .filter-group select option {
            background: #1e293b;
            color: #e1e9f0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-warning:hover {
            background: #b45309;
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background: #334155;
        }

        .btn-info {
            background: #0891b2;
            color: white;
        }

        .btn-info:hover {
            background: #0e7490;
        }

        .actions {
            padding: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            background: #111827;
            border-bottom: 1px solid #2d3748;
            flex-wrap: wrap;
        }

        .summary-cards {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border-left: 5px solid;
            border: 1px solid #334155;
        }

        .card.total {
            border-left-color: #3b82f6;
        }

        .card.repair {
            border-left-color: #f59e0b;
        }

        .card.buy {
            border-left-color: #10b981;
        }

        .card.savings {
            border-left-color: #8b5cf6;
        }

        .card h3 {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card .value {
            font-size: 28px;
            font-weight: bold;
            color: #f8fafc;
        }

        .card .subtitle {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .selection-bar {
            padding: 15px 20px;
            background: #0f172a;
            margin: 0 20px 20px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #2d3748;
            flex-wrap: wrap;
        }

        .selection-info {
            flex: 1;
            font-size: 14px;
            color: #94a3b8;
        }

        .selection-info strong {
            color: #60a5fa;
            font-size: 18px;
        }

        .table-container {
            padding: 0 20px 20px 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            color: #e1e9f0;
            border: 1px solid #2d3748;
        }

        th {
            background: #1e293b;
            color: #94a3b8;
            padding: 12px 8px;
            font-weight: 600;
            text-align: left;
            border-bottom: 2px solid #3b82f6;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #334155;
        }

        tr:nth-child(even) {
            background: #1a1f2b;
        }

        tr:hover {
            background: #263445;
        }

        tr.selected {
            background: #1e3a5f !important;
        }

        .checkbox-cell {
            width: 30px;
            text-align: center;
        }

        .checkbox-cell input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-Reservado,
        .status-reservado {
            background: #6b21a8;
            color: #f3e8ff;
        }

        .status-Dispon√≠vel,
        .status-dispon√≠vel,
        .status-Disponivel,
        .status-disponivel {
            background: #065f46;
            color: #d1fae5;
        }

        .status-Manuten√ß√£o,
        .status-manuten√ß√£o,
        .status-Manutencao,
        .status-manutencao {
            background: #991b1b;
            color: #fee2e2;
        }

        .status-Danificado,
        .status-danificado {
            background: #991b1b;
            color: #fee2e2;
        }

        .status-Bom,
        .status-bom {
            background: #065f46;
            color: #d1fae5;
        }

        .decision-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .decision-repair {
            background: #f59e0b;
            color: #000;
        }

        .decision-buy {
            background: #10b981;
            color: #000;
        }

        .valor-input {
            width: 100px;
            padding: 6px 8px;
            background: #1e293b;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            color: #e1e9f0;
            font-size: 13px;
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .valor-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .valor-input::placeholder {
            color: #64748b;
            font-style: italic;
        }

        .file-upload {
            position: relative;
            display: inline-block;
        }

        .file-upload input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            backdrop-filter: blur(4px);
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #1e293b;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Estilo para a barra de informa√ß√£o (mantendo o mesmo padr√£o visual) */
        .info-bar {
            background: #1e3a5f;
            color: #e1e9f0;
            padding: 10px 20px;
            margin: 0 20px 20px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            border-left: 5px solid #3b82f6;
        }
    </style>
</head>

<body>
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div id="loadingMessage">Processando dados...</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Comparativo: Consertar vs Comprar Ferramentas</h1>
            <p>An√°lise de viabilidade econ√¥mica para ferramentas v2</p>
        </div>

        <!-- Box com logos -->
        <div class="logos-box">
            <div class="logo-item">
                <div class="logo-fw">FW</div>
                <span>Galp√£o FW</span>
            </div>
            <div class="logo-item">
                <div class="logo-delservin">DS</div>
                <span>Delservin</span>
            </div>
            <div class="logo-item">
                <div class="logo-altercon">AC</div>
                <span>Altercon</span>
            </div>
        </div>

        <!-- Barra de informa√ß√£o da fonte de dados -->
        <div class="info-bar" id="infoBar">
            <i class="fas fa-cloud" id="infoIcon"></i>
            <span id="infoMessage">Carregando dados do Supabase...</span>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Status</label>
                <select id="statusFilter">
                    <option value="todos">Todos os Status</option>
                    <option value="Dispon√≠vel">Dispon√≠vel</option>
                    <option value="manuten√ß√£o">Em Manuten√ß√£o</option>
                    <option value="danificado">Danificado</option>
                    <option value="bom">Bom</option>
                    <option value="reservado">Reservado</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Categoria</label>
                <select id="categoriaFilter">
                    <option value="todos">Todas as Categorias</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Buscar</label>
                <input type="text" id="searchFilter" placeholder="Nome ou patrim√¥nio...">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="aplicarFiltros()">
                    üîç Aplicar Filtros
                </button>
            </div>
        </div>

        <div class="summary-cards" id="summaryCards">
            <!-- Cards ser√£o preenchidos dinamicamente -->
        </div>

        <!-- Barra de sele√ß√£o -->
        <div class="selection-bar">
            <div class="selection-info">
                <span><strong id="selectedCount">0</strong> itens selecionados</span>
                <span style="margin-left: 20px;">Total: R$ <span id="selectedTotal">0,00</span></span>
            </div>
            <button class="btn btn-secondary" onclick="selecionarTodos()">
                <i class="fas fa-check-double"></i> Selecionar Todos
            </button>
            <button class="btn btn-secondary" onclick="limparSelecao()">
                <i class="fas fa-times"></i> Limpar Sele√ß√£o
            </button>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="recarregarDoSupabase()">
                <i class="fas fa-sync-alt"></i> Recarregar do Supabase
            </button>
            <div class="file-upload">
                <button class="btn btn-info">
                    <i class="fas fa-file-import"></i> Importar CSV
                </button>
                <input type="file" id="csvUpload" accept=".csv,.xlsx,.xls" onchange="importarArquivo(this)">
            </div>
            <button class="btn btn-success" onclick="gerarExcelRomaneio()">
                üìä Gerar Excel (Layout Romaneio)
            </button>
        </div>

        <div class="table-container">
            <table id="tabelaFerramentas">
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox"
                                onclick="toggleAllCheckboxes(this)"></th>
                        <th>N¬∫</th>
                        <th>Patrim√¥nio</th>
                        <th>Ferramenta</th>
                        <th>Status</th>
                        <th>Custo Conserto (R$)</th>
                        <th>Pre√ßo Novo (R$)</th>
                        <th>Economia (R$)</th>
                        <th>Economia %</th>
                        <th>Decis√£o</th>
                    </tr>
                </thead>
                <tbody id="tabelaBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">
                            <i class="fas fa-cloud" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                            <br>
                            Carregando dados do Supabase...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO SUPABASE
        // ============================================
        const SUPABASE_CONFIG = {
            url: 'https://eokhafnfmynhridksnuh.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVva2hhZm5mbXluaHJpZGtzbnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzYwMDIsImV4cCI6MjA4NTcxMjAwMn0.-RZtzUYpdOI4_WKOmP9lqw9guJmvh8XFeAL6UXhA4vo'
        };

        // ============================================
        // DADOS GLOBAIS
        // ============================================
        let ferramentas = [];
        let categorias = [];
        let custosConserto = {};
        let precosNovo = {};
        let selectedItems = new Set();

        // ============================================
        // FUN√á√ÉO AUXILIAR: FORMATAR VALOR BR
        // ============================================
        function formatarValorBR(valor) {
            if (valor === undefined || valor === null) return '0,00';
            return valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        // ============================================
        // FUN√á√ÉO AUXILIAR: CONVERTER STRING PARA NUM√âRICO
        // ============================================
        function converterParaNumero(valor) {
            if (typeof valor === 'number') return valor;
            if (!valor) return 0;
            
            let valorStr = String(valor).trim();
            valorStr = valorStr.replace(/[Rr]\$\s*/g, '');
            
            if (valorStr.includes(',') && !valorStr.includes('.')) {
                valorStr = valorStr.replace(/\./g, '');
                valorStr = valorStr.replace(',', '.');
            } else if (valorStr.includes(',') && valorStr.includes('.')) {
                const ultimaVirgula = valorStr.lastIndexOf(',');
                const ultimoPonto = valorStr.lastIndexOf('.');
                
                if (ultimoPonto > ultimaVirgula) {
                    valorStr = valorStr.replace(/,/g, '');
                } else {
                    valorStr = valorStr.replace(/\./g, '');
                    valorStr = valorStr.replace(',', '.');
                }
            }
            
            const num = parseFloat(valorStr);
            return isNaN(num) ? 0 : num;
        }

        // ============================================
        // BUSCAR DADOS DO SUPABASE (PRINCIPAL)
        // ============================================
        async function buscarDoSupabase() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingMessage').innerHTML = 'Calma Emerson afobado...';
            document.getElementById('infoMessage').innerHTML = 'Conectando ao Servidor...';
            document.getElementById('infoIcon').className = 'fas fa-cloud';

            try {
                const url = `${SUPABASE_CONFIG.url}/rest/v1/tools?select=*`;
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.key,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.key}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const dados = await response.json();
                
                if (dados && dados.length > 0) {
                    processarDadosSupabase(dados);
                    document.getElementById('infoMessage').innerHTML = 'Dados carregados do Supabase (online)';
                } else {
                    throw new Error('Nenhum dado encontrado');
                }

            } catch (error) {
                console.error('Erro ao buscar do Supabase:', error);
                document.getElementById('infoMessage').innerHTML = 'Erro ao conectar. Use "Importar CSV" para dados offline.';
                document.getElementById('infoIcon').className = 'fas fa-exclamation-triangle';
                
                // Limpar tabela
                ferramentas = [];
                categorias = [];
                custosConserto = {};
                precosNovo = {};
                aplicarFiltros();
                
            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // ============================================
        // PROCESSAR DADOS DO SUPABASE
        // ============================================
        function processarDadosSupabase(dados) {
            ferramentas = dados.map(tool => ({
                id: tool.id,
                patrimonio: tool.patrimonio || tool.code || `ID-${tool.id}`,
                nome: tool.name || tool.nome || 'Sem nome',
                categoria: tool.category || tool.categoria || 'Geral',
                status: tool.status || 'Dispon√≠vel',
                valor_compra: tool.preco || tool.valor_compra || 0
            }));

            categorias = [...new Set(ferramentas.map(f => f.categoria))];
            
            // Inicializar pre√ßos com base no valor de compra
            ferramentas.forEach(f => {
                if (f.valor_compra > 0) {
                    precosNovo[f.id] = f.valor_compra;
                }
            });

            atualizarFiltrosCategoria();
            aplicarFiltros();
        }

        // ============================================
        // RECARREGAR DO SUPABASE
        // ============================================
        function recarregarDoSupabase() {
            buscarDoSupabase();
        }

        // ============================================
        // IMPORTAR ARQUIVO (CSV/EXCEL) - OFFLINE
        // ============================================
        function importarArquivo(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const reader = new FileReader();

            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingMessage').innerHTML = `Processando ${file.name}...`;
            document.getElementById('infoMessage').innerHTML = `Dados carregados do arquivo: ${file.name} (offline)`;
            document.getElementById('infoIcon').className = 'fas fa-file-import';

            reader.onload = function(e) {
                try {
                    const data = e.target.result;
                    const extension = file.name.split('.').pop().toLowerCase();

                    if (extension === 'csv') {
                        processarCSV(data);
                    } else {
                        processarExcel(data);
                    }
                    
                    input.value = '';
                    
                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao processar arquivo: ' + error.message);
                    document.getElementById('loading').classList.remove('active');
                }
            };

            reader.onerror = function() {
                alert('Erro ao ler o arquivo');
                document.getElementById('loading').classList.remove('active');
            };

            if (file.name.endsWith('.csv')) {
                reader.readAsText(file, 'UTF-8');
            } else {
                reader.readAsBinaryString(file);
            }
        }

        // ============================================
        // PROCESSAR CSV
        // ============================================
        function processarCSV(csvData) {
            try {
                const linhas = csvData.split('\n')
                    .map(linha => linha.trim())
                    .filter(linha => linha.length > 0);
                
                if (linhas.length < 2) throw new Error('Arquivo CSV vazio');

                const primeiraLinha = linhas[0];
                const separador = primeiraLinha.includes(';') ? ';' : ',';
                
                let cabecalho = linhas[0].split(separador).map(item => 
                    item.replace(/^\uFEFF/, '').replace(/^["']|["']$/g, '').trim()
                );

                ferramentas = [];
                custosConserto = {};
                precosNovo = {};

                for (let i = 1; i < linhas.length; i++) {
                    const linha = linhas[i];
                    if (!linha.trim()) continue;
                    
                    const colunas = [];
                    let dentroAspas = false;
                    let valorAtual = '';
                    
                    for (let char of linha) {
                        if (char === '"') {
                            dentroAspas = !dentroAspas;
                        } else if (char === separador && !dentroAspas) {
                            colunas.push(valorAtual);
                            valorAtual = '';
                        } else {
                            valorAtual += char;
                        }
                    }
                    colunas.push(valorAtual);
                    
                    const colunasLimpas = colunas.map(val => 
                        val.replace(/^["']|["']$/g, '').trim()
                    );
                    
                    if (colunasLimpas.length < 5) continue;

                    const id = i;
                    
                    let patrimonio = colunasLimpas[1] || `ID-${id}`;
                    let nome = colunasLimpas[2] || 'Sem nome';
                    let status = colunasLimpas[3] || 'Reservado';
                    let custo = colunasLimpas[5] ? converterParaNumero(colunasLimpas[5]) : 0;
                    let precoNovo = colunasLimpas[6] ? converterParaNumero(colunasLimpas[6]) : 0;

                    ferramentas.push({
                        id: id,
                        patrimonio: patrimonio,
                        nome: nome,
                        categoria: 'Geral',
                        status: status
                    });

                    if (custo > 0) custosConserto[id] = custo;
                    if (precoNovo > 0) precosNovo[id] = precoNovo;
                }

                if (ferramentas.length === 0) throw new Error('Nenhuma ferramenta encontrada');

                categorias = [...new Set(ferramentas.map(f => f.categoria))];
                atualizarFiltrosCategoria();
                aplicarFiltros();
                selecionarTodos();
                
                document.getElementById('loading').classList.remove('active');
                alert(`${ferramentas.length} ferramentas importadas com sucesso!`);
                
            } catch (error) {
                console.error('Erro ao processar CSV:', error);
                alert('Erro ao processar arquivo CSV: ' + error.message);
                document.getElementById('loading').classList.remove('active');
            }
        }

        // ============================================
        // PROCESSAR EXCEL
        // ============================================
        function processarExcel(data) {
            try {
                const workbook = XLSX.read(data, { type: 'binary' });
                const primeiraPlanilha = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[primeiraPlanilha];
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) throw new Error('Arquivo sem dados');

                ferramentas = [];
                custosConserto = {};
                precosNovo = {};

                for (let i = 1; i < jsonData.length; i++) {
                    const linha = jsonData[i];
                    if (!linha || linha.length === 0) continue;

                    const id = i;
                    
                    const patrimonio = linha[1] ? String(linha[1]).trim() : `ID-${id}`;
                    const nome = linha[2] ? String(linha[2]).trim() : 'Sem nome';
                    const status = linha[3] ? String(linha[3]).trim() : 'Reservado';
                    
                    const custo = linha[5] ? converterParaNumero(linha[5]) : 0;
                    const precoNovo = linha[6] ? converterParaNumero(linha[6]) : 0;

                    ferramentas.push({
                        id: id,
                        patrimonio: patrimonio,
                        nome: nome,
                        categoria: 'Geral',
                        status: status
                    });

                    if (custo > 0) custosConserto[id] = custo;
                    if (precoNovo > 0) precosNovo[id] = precoNovo;
                }

                if (ferramentas.length === 0) throw new Error('Nenhuma ferramenta encontrada');

                categorias = [...new Set(ferramentas.map(f => f.categoria))];
                atualizarFiltrosCategoria();
                aplicarFiltros();
                selecionarTodos();
                
                document.getElementById('loading').classList.remove('active');
                alert(`${ferramentas.length} ferramentas importadas com sucesso!`);
                
            } catch (error) {
                console.error('Erro ao processar Excel:', error);
                alert('Erro ao processar arquivo Excel: ' + error.message);
                document.getElementById('loading').classList.remove('active');
            }
        }

        // ============================================
        // ATUALIZAR FILTROS DE CATEGORIA
        // ============================================
        function atualizarFiltrosCategoria() {
            const catSelect = document.getElementById('categoriaFilter');
            catSelect.innerHTML = '<option value="todos">Todas as Categorias</option>';
            categorias.sort().forEach(cat => {
                catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        // ============================================
        // APLICAR FILTROS
        // ============================================
        function aplicarFiltros() {
            const status = document.getElementById('statusFilter').value;
            const categoria = document.getElementById('categoriaFilter').value;
            const busca = document.getElementById('searchFilter').value.toLowerCase();

            let filtradas = ferramentas.filter(f => {
                if (status !== 'todos') {
                    const statusFerramenta = f.status ? f.status.toLowerCase() : '';
                    const statusFiltro = status.toLowerCase();
                    
                    if (statusFiltro === 'manuten√ß√£o' && !statusFerramenta.includes('manuten')) return false;
                    else if (statusFiltro === 'danificado' && !statusFerramenta.includes('danific')) return false;
                    else if (statusFiltro === 'dispon√≠vel' && !statusFerramenta.includes('dispon')) return false;
                    else if (statusFiltro === 'bom' && !statusFerramenta.includes('bom')) return false;
                    else if (statusFiltro === 'reservado' && !statusFerramenta.includes('reserv')) return false;
                }

                if (categoria !== 'todos' && f.categoria !== categoria) return false;

                if (busca) {
                    const nomeMatch = f.nome ? f.nome.toLowerCase().includes(busca) : false;
                    const patrimMatch = f.patrimonio ? f.patrimonio.toLowerCase().includes(busca) : false;
                    if (!nomeMatch && !patrimMatch) return false;
                }

                return true;
            });

            atualizarTabela(filtradas);
            atualizarCards(filtradas);
            atualizarResumoSelecao();
        }

        // ============================================
        // ATUALIZAR TABELA
        // ============================================
        function atualizarTabela(ferramentasFiltradas) {
            const tbody = document.getElementById('tabelaBody');

            if (ferramentasFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">
                            Nenhuma ferramenta encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            ferramentasFiltradas.forEach((ferramenta, index) => {
                const custoConserto = custosConserto[ferramenta.id] || 0;
                const valorNovo = precosNovo[ferramenta.id] || 0;

                let diferenca = 0;
                let economiaPercentual = 0;
                let decisao = 'A DEFINIR';

                if (custoConserto > 0 && valorNovo > 0) {
                    diferenca = valorNovo - custoConserto;
                    economiaPercentual = valorNovo > 0 ? (diferenca / valorNovo) * 100 : 0;
                    decisao = diferenca > 0 ? 'CONSERTAR' : 'COMPRAR NOVO';
                }

                const selectedClass = selectedItems.has(ferramenta.id) ? 'selected' : '';

                let statusClass = '';
                const statusLower = ferramenta.status ? ferramenta.status.toLowerCase() : '';

                if (statusLower.includes('danific')) {
                    statusClass = 'Danificado';
                } else if (statusLower.includes('manuten')) {
                    statusClass = 'Manuten√ß√£o';
                } else if (statusLower.includes('dispon')) {
                    statusClass = 'Dispon√≠vel';
                } else if (statusLower.includes('bom')) {
                    statusClass = 'Bom';
                } else if (statusLower.includes('reserv')) {
                    statusClass = 'Reservado';
                } else {
                    statusClass = 'Dispon√≠vel';
                }

                html += `
                    <tr class="${selectedClass}">
                        <td class="checkbox-cell">
                            <input type="checkbox" 
                                   ${selectedItems.has(ferramenta.id) ? 'checked' : ''}
                                   onchange="toggleItemSelection(${ferramenta.id}, this.checked)">
                        </td>
                        <td>${index + 1}</td>
                        <td><strong>${ferramenta.patrimonio}</strong></td>
                        <td>${ferramenta.nome}</td>
                        <td>
                            <span class="status-badge status-${statusClass}">
                                ${ferramenta.status}
                            </span>
                        </td>
                        <td>
                            <input type="text" class="valor-input" 
                                   value="${custoConserto > 0 ? custoConserto.toFixed(2).replace('.', ',') : ''}"
                                   onchange="atualizarCustoConserto(${ferramenta.id}, this.value)"
                                   placeholder="0,00">
                        </td>
                        <td>
                            <input type="text" class="valor-input" 
                                   value="${valorNovo > 0 ? valorNovo.toFixed(2).replace('.', ',') : ''}"
                                   onchange="atualizarPrecoNovo(${ferramenta.id}, this.value)"
                                   placeholder="0,00">
                        </td>
                        <td style="color: ${diferenca > 0 ? '#34d399' : '#f87171'}; font-weight: bold;">
                            ${diferenca !== 0 ? (diferenca > 0 ? '+' : '-') + 'R$ ' + formatarValorBR(Math.abs(diferenca)) : ''}
                        </td>
                        <td style="color: ${economiaPercentual > 0 ? '#34d399' : '#f87171'};">
                            ${economiaPercentual !== 0 ? economiaPercentual.toFixed(1).replace('.', ',') + '%' : ''}
                        </td>
                        <td>
                            ${decisao !== 'A DEFINIR' ?
                        `<span class="decision-badge decision-${decisao === 'CONSERTAR' ? 'repair' : 'buy'}">
                                    ${decisao}
                                </span>` :
                        '<span style="color: #64748b;">-</span>'}
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // ============================================
        // ATUALIZAR CARDS
        // ============================================
        function atualizarCards(ferramentasFiltradas) {
            let totalConserto = 0;
            let totalNovo = 0;
            let totalEconomia = 0;

            ferramentasFiltradas.forEach(f => {
                const custoConserto = custosConserto[f.id] || 0;
                const valorNovo = precosNovo[f.id] || 0;

                totalConserto += custoConserto;
                totalNovo += valorNovo;

                if (custoConserto > 0 && valorNovo > 0 && valorNovo > custoConserto) {
                    totalEconomia += (valorNovo - custoConserto);
                }
            });

            const cardsHtml = `
                <div class="card total">
                    <h3>Total Ferramentas</h3>
                    <div class="value">${ferramentasFiltradas.length}</div>
                    <div class="subtitle">itens analisados</div>
                </div>
                <div class="card repair">
                    <h3>Custo Total Conserto</h3>
                    <div class="value">R$ ${formatarValorBR(totalConserto)}</div>
                    <div class="subtitle">valores digitados</div>
                </div>
                <div class="card buy">
                    <h3>Custo Total Novo</h3>
                    <div class="value">R$ ${formatarValorBR(totalNovo)}</div>
                    <div class="subtitle">valores digitados</div>
                </div>
                <div class="card savings">
                    <h3>Economia Potencial</h3>
                    <div class="value">R$ ${formatarValorBR(totalEconomia)}</div>
                    <div class="subtitle">optando por consertar</div>
                </div>
            `;

            document.getElementById('summaryCards').innerHTML = cardsHtml;
        }

        // ============================================
        // FUN√á√ïES DE SELE√á√ÉO
        // ============================================
        function toggleItemSelection(id, checked) {
            if (checked) selectedItems.add(id);
            else selectedItems.delete(id);
            atualizarResumoSelecao();
            aplicarFiltros();
        }

        function selecionarTodos() {
            ferramentas.forEach(f => selectedItems.add(f.id));
            aplicarFiltros();
        }

        function limparSelecao() {
            selectedItems.clear();
            aplicarFiltros();
        }

        function toggleAllCheckboxes(checkbox) {
            if (checkbox.checked) {
                ferramentas.forEach(f => selectedItems.add(f.id));
            } else {
                selectedItems.clear();
            }
            aplicarFiltros();
        }

        function atualizarResumoSelecao() {
            const selecionados = ferramentas.filter(f => selectedItems.has(f.id));
            const totalSelecionado = selecionados.reduce((acc, f) => acc + (f.valor_compra || 0), 0);

            document.getElementById('selectedCount').innerHTML = selecionados.length;
            document.getElementById('selectedTotal').innerHTML = formatarValorBR(totalSelecionado);
        }

        // ============================================
        // ATUALIZAR VALORES DIGITADOS
        // ============================================
        function atualizarCustoConserto(id, valor) {
            const num = converterParaNumero(valor);
            custosConserto[id] = num;
            aplicarFiltros();
        }

        function atualizarPrecoNovo(id, valor) {
            const num = converterParaNumero(valor);
            precosNovo[id] = num;
            aplicarFiltros();
        }

        // ============================================
        // GERAR EXCEL COM LAYOUT DO ROMANEIO
        // ============================================
        function gerarExcelRomaneio() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingMessage').innerHTML = 'Gerando arquivo Excel...';

            setTimeout(() => {
                try {
                    const selecionados = ferramentas.filter(f => selectedItems.has(f.id));

                    if (selecionados.length === 0) {
                        alert('Selecione pelo menos um item para exportar');
                        document.getElementById('loading').classList.remove('active');
                        return;
                    }

                    const wb = XLSX.utils.book_new();

                    // PLANILHA 1: ROMANEIO
                    const dadosRomaneio = [
                        ['', 'ROMANEIO', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                        ['', 'N¬∫', 'RM-2026-798754', '', '', '', '', '', '', '', '', '', '', '', '', '', 'DATA:', '23/01/2026'],
                        [''],
                        ['', 'REMETENTE:', '', 'Delservin Com√©rcio e Servi√ßos Industriais Ltda. - DESTINAT√ÅRIO: Galp√£o FW, Imperatriz-MA', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
                        ['', 'END. REMT.:', '', 'Rua da Urca, 213 - Jd. Guanabara / Americana-SP', '', '', '', '', '', '', 'CNPJ:', '', '', '', '', '', '', ''],
                        ['', 'CNPJ:', '', '01.864.998/0001-35', '', '', '', '', '', '', 'END.:', '', '', '', '', '', '', ''],
                        ['', 'MOTORISTA:', '', 'Fabio Mendes R', '', '', '', '', '', '', 'CEP:', '', '', '', '', '', '', ''],
                        ['', 'TRANSPORTE:', '', 'FW Transportes', '', '', '', '', '', '', 'CEN. DE CUST.:', 'ALMOXARIFADO', '', '', '', '', '', ''],
                        [''],
                        ['', 'N¬∫', 'DESCRI√á√ÉO DE MATERIAL', '', '', '', '', '', '', '', 'N.C.M.', 'N¬∫ PATR.', 'QTD.', 'DESCRI√á√ÉO', '', '', 'VAL. UNIT', '']
                    ];

                    selecionados.forEach((item, index) => {
                        dadosRomaneio.push([
                            '',
                            index + 1,
                            item.nome,
                            '', '', '', '', '', '', '',
                            '',  // NCM (vazio)
                            item.patrimonio,
                            '1',
                            item.categoria || '',
                            '', '',
                            (item.valor_compra || 0).toFixed(2).replace('.', ','),
                            ''
                        ]);
                    });

                    const totalValor = selecionados.reduce((acc, item) => acc + (item.valor_compra || 0), 0);
                    dadosRomaneio.push(['', 'TOTAL', '', '', '', '', '', '', '', '', '', '', '', '', '', '', totalValor.toFixed(2).replace('.', ','), '']);
                    dadosRomaneio.push(['']);
                    dadosRomaneio.push(['', 'OBSERVA√á√ïES: An√°lise para conserto vs compra', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
                    dadosRomaneio.push(['']);
                    dadosRomaneio.push(['', 'Respons√°vel pelo Romaneio:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
                    dadosRomaneio.push(['', '________________________________________', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);
                    dadosRomaneio.push(['', 'Fabio Mendes R', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']);

                    const wsRomaneio = XLSX.utils.aoa_to_sheet(dadosRomaneio);
                    XLSX.utils.book_append_sheet(wb, wsRomaneio, 'ROMANEIO');

                    // PLANILHA 2: AN√ÅLISE
                    const dadosAnalise = selecionados.map((item, index) => ({
                        'N¬∫': index + 1,
                        'Patrim√¥nio': item.patrimonio,
                        'Ferramenta': item.nome,
                        'Status': item.status,
                        'Custo Conserto (R$)': (custosConserto[item.id] || 0).toFixed(2).replace('.', ','),
                        'Pre√ßo Novo (R$)': (precosNovo[item.id] || 0).toFixed(2).replace('.', ','),
                        'Economia (R$)': ((precosNovo[item.id] || 0) - (custosConserto[item.id] || 0)).toFixed(2).replace('.', ','),
                        'Decis√£o': (precosNovo[item.id] || 0) > (custosConserto[item.id] || 0) ? 'CONSERTAR' : 'COMPRAR NOVO'
                    }));

                    const wsAnalise = XLSX.utils.json_to_sheet(dadosAnalise);
                    XLSX.utils.book_append_sheet(wb, wsAnalise, 'An√°lise Comparativa');

                    const dataAtual = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
                    XLSX.writeFile(wb, `romaneio_analise_${dataAtual}.xlsx`);

                    document.getElementById('loading').classList.remove('active');
                    alert('Arquivo Excel gerado com sucesso!');

                } catch (error) {
                    console.error('Erro:', error);
                    document.getElementById('loading').classList.remove('active');
                    alert('Erro ao gerar Excel');
                }
            }, 500);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('statusFilter').addEventListener('change', aplicarFiltros);
        document.getElementById('categoriaFilter').addEventListener('change', aplicarFiltros);
        document.getElementById('searchFilter').addEventListener('keyup', aplicarFiltros);

        // INICIALIZA√á√ÉO
        window.addEventListener('load', function() {
            buscarDoSupabase();
        });
    </script>
</body>

</html>
