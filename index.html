<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparativo: Consertar vs Comprar Ferramentas</title>
    <link rel="icon" type="image/x-icon" href="fw_mini.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Usando ExcelJS -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <style>
        /* MANTENDO EXATAMENTE O CSS ORIGINAL */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0c10;
            padding: 20px;
            min-height: 100vh;
            color: #e1e9f0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: #1a1f2b;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #2d3748;
        }

        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e1e9f0;
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid #2d3748;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            color: #60a5fa;
        }

        .header p {
            font-size: 16px;
            opacity: 0.8;
            color: #94a3b8;
        }

        .logos-box {
            background: #0f172a;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 30px;
            border-bottom: 1px solid #2d3748;
        }

        .logo-item {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }

        .logo-fw,
        .logo-delservin,
        .logo-altercon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .logo-fw {
            background: #3b82f6;
        }

        .logo-delservin {
            background: #059669;
        }

        .logo-altercon {
            background: #d97706;
        }

        .filters {
            padding: 20px;
            background: #111827;
            border-bottom: 1px solid #2d3748;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: bold;
            color: #94a3b8;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 12px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            font-size: 14px;
            color: #e1e9f0;
            transition: all 0.3s;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .filter-group select option {
            background: #1e293b;
            color: #e1e9f0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: #059669;
            color: white;
        }

        .btn-success:hover {
            background: #047857;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3);
        }

        .btn-warning {
            background: #d97706;
            color: white;
        }

        .btn-warning:hover {
            background: #b45309;
        }

        .btn-secondary {
            background: #475569;
            color: white;
        }

        .btn-secondary:hover {
            background: #334155;
        }

        .btn-info {
            background: #0891b2;
            color: white;
        }

        .btn-info:hover {
            background: #0e7490;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid #3b82f6;
            color: #3b82f6;
        }

        .btn-outline:hover {
            background: #3b82f6;
            color: white;
        }

        .btn-outline.active {
            background: #3b82f6;
            color: white;
        }

        .actions {
            padding: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            background: #111827;
            border-bottom: 1px solid #2d3748;
            flex-wrap: wrap;
        }

        .view-toggle {
            padding: 0 20px 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .view-toggle .btn {
            flex: 1;
            max-width: 200px;
        }

        .summary-cards {
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .card {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border-left: 5px solid;
            border: 1px solid #334155;
        }

        .card.total {
            border-left-color: #3b82f6;
        }

        .card.repair {
            border-left-color: #f59e0b;
        }

        .card.buy {
            border-left-color: #10b981;
        }

        .card.savings {
            border-left-color: #8b5cf6;
        }

        .card h3 {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card .value {
            font-size: 28px;
            font-weight: bold;
            color: #f8fafc;
        }

        .card .subtitle {
            font-size: 12px;
            color: #64748b;
            margin-top: 5px;
        }

        .selection-bar {
            padding: 15px 20px;
            background: #0f172a;
            margin: 0 20px 20px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            border: 1px solid #2d3748;
            flex-wrap: wrap;
        }

        .selection-info {
            flex: 1;
            font-size: 14px;
            color: #94a3b8;
        }

        .selection-info strong {
            color: #60a5fa;
            font-size: 18px;
        }

        .table-container {
            padding: 0 20px 20px 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            color: #e1e9f0;
            border: 1px solid #2d3748;
        }

        th {
            background: #1e293b;
            color: #94a3b8;
            padding: 12px 8px;
            font-weight: 600;
            text-align: left;
            border-bottom: 2px solid #3b82f6;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 10px 8px;
            border-bottom: 1px solid #334155;
        }

        tr {
            background: #1e293b;
        }

        tr:hover {
            background: #2d3748;
        }

        tr.selected {
            background: #1e3a5f !important;
        }

        .checkbox-cell {
            width: 30px;
            text-align: center;
        }

        .checkbox-cell input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3b82f6;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-Reservado,
        .status-reservado {
            background: #6b21a8;
            color: #f3e8ff;
        }

        .status-Dispon√≠vel,
        .status-dispon√≠vel,
        .status-Disponivel,
        .status-disponivel {
            background: #065f46;
            color: #d1fae5;
        }

        .status-Manuten√ß√£o,
        .status-manuten√ß√£o,
        .status-Manutencao,
        .status-manutencao {
            background: #991b1b;
            color: #fee2e2;
        }

        .status-Danificado,
        .status-danificado {
            background: #991b1b;
            color: #fee2e2;
        }

        .status-Bom,
        .status-bom {
            background: #065f46;
            color: #d1fae5;
        }

        .decision-badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .decision-repair {
            background: #f59e0b;
            color: #000;
        }

        .decision-buy {
            background: #10b981;
            color: #000;
        }

        .valor-input {
            width: 100px;
            padding: 6px 8px;
            background: #1e293b;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            color: #e1e9f0;
            font-size: 13px;
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .valor-input:focus {
            outline: none;
            border-color: #60a5fa;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .valor-input::placeholder {
            color: #64748b;
            font-style: italic;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            backdrop-filter: blur(4px);
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 80px;
            height: 80px;
            border: 6px solid #1e293b;
            border-top: 6px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .info-bar {
            background: #1e3a5f;
            color: #e1e9f0;
            padding: 10px 20px;
            margin: 0 20px 20px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            border-left: 5px solid #3b82f6;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <!-- Loading com logos -->
    <div class="loading" id="loading">
        <div
            style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh;">
            <div style="display: flex; align-items: center; gap: 30px; margin-bottom: 40px;">
                <img src="FW Logo.png" alt="FW" style="width: 150px; height: 30px; object-fit: contain;">
                <img src="Altercon Logo.png" alt="Altercon" style="width: 150px; height: 30px; object-fit: contain;">
                <img src="Delservin Logo.png" alt="Delservin" style="width: 150px; height: 30px; object-fit: contain;">
            </div>
            <div class="spinner"></div>
            <div id="loadingMessage" style="margin-top: 20px; font-size: 16px;">Carregando dados do Supabase...</div>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <h1>Comparativo: Consertar vs Comprar Ferramentas</h1>
            <p>An√°lise de viabilidade econ√¥mica para ferramentas V2</p>
        </div>

        <!-- Box com logos (MANTIDO ORIGINAL) -->
        <div class="logos-box" style="display: flex; align-items: center; justify-content: space-between;">
            <!-- FW (esquerda) -->
            <div class="logo-item">
                <img src="FW Logo.png" alt="FW Logo" style="width: 200px; height: 50px; object-fit: contain;"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="logo-fw" style="display: none;">FW</div>
            </div>

            <!-- Altercon (centro) -->
            <div class="logo-item" style="margin-left: 300px;">
                <img src="Altercon Logo.png" alt="Altercon Logo"
                    style="width: 200px; height: 50px; object-fit: contain;"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="logo-altercon" style="display: none;">AC</div>
            </div>

            <!-- Delservin (direita) -->
            <div class="logo-item" style="margin-left: auto;">
                <img src="Delservin Logo.png" alt="Delservin Logo"
                    style="width: 200px; height: 40px; object-fit: contain;"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div class="logo-delservin" style="display: none;">DS</div>
            </div>
        </div>

        <!-- Barra de informa√ß√£o da fonte de dados -->
        <div class="info-bar" id="infoBar">
            <i class="fas fa-cloud" id="infoIcon"></i>
            <span id="infoMessage">Carregando dados do Supabase...</span>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>Status</label>
                <select id="statusFilter">
                    <option value="todos">Todos os Status</option>
                    <option value="Dispon√≠vel">Dispon√≠vel</option>
                    <option value="manuten√ß√£o">Em Manuten√ß√£o</option>
                    <option value="danificado">Danificado</option>
                    <option value="bom">Bom</option>
                    <option value="reservado">Reservado</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Categoria</label>
                <select id="categoriaFilter">
                    <option value="todos">Todas as Categorias</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Buscar</label>
                <input type="text" id="searchFilter" placeholder="Nome ou patrim√¥nio...">
            </div>
            <div class="filter-group">
                <label>&nbsp;</label>
                <button class="btn btn-primary" onclick="aplicarFiltros()">
                    üîç Aplicar Filtros
                </button>
            </div>
        </div>

        <!-- Bot√µes de visualiza√ß√£o (MANTIDO) -->
        <div class="view-toggle">
            <button class="btn btn-outline active" id="viewAllBtn" onclick="alternarVisualizacao('todos')">
                <i class="fas fa-list"></i> Todos os Itens
            </button>
            <button class="btn btn-outline" id="viewSelectedBtn" onclick="alternarVisualizacao('selecionados')">
                <i class="fas fa-check-circle"></i> Apenas Selecionados
            </button>
        </div>

        <div class="summary-cards" id="summaryCards">
            <!-- Cards ser√£o preenchidos dinamicamente -->
        </div>

        <!-- Barra de sele√ß√£o -->
        <div class="selection-bar">
            <div class="selection-info">
                <span><strong id="selectedCount">0</strong> itens selecionados</span>
                <span style="margin-left: 20px;">Total: R$ <span id="selectedTotal">0,00</span></span>
            </div>
            <button class="btn btn-secondary" onclick="selecionarTodos()">
                <i class="fas fa-check-double"></i> Selecionar Todos
            </button>
            <button class="btn btn-secondary" onclick="limparSelecao()">
                <i class="fas fa-times"></i> Limpar Sele√ß√£o
            </button>
        </div>

        <div class="actions">
            <button class="btn btn-primary" onclick="recarregarDoSupabase()">
                <i class="fas fa-sync-alt"></i> Recarregar do Supabase
            </button>
            <button class="btn btn-info" onclick="document.getElementById('csvUpload').click()">
                <i class="fas fa-file-import"></i> Importar CSV
            </button>
            <input type="file" id="csvUpload" style="display: none;" accept=".csv,.xlsx,.xls"
                onchange="importarArquivo(this)">
            <button class="btn btn-success" onclick="gerarExcelComparativo()">
                üìä Gerar Excel (An√°lise Comparativa)
            </button>
        </div>

        <div class="table-container">
            <table id="tabelaFerramentas">
                <thead>
                    <tr>
                        <th class="checkbox-cell"><input type="checkbox" id="selectAllCheckbox"
                                onclick="toggleAllCheckboxes(this)"></th>
                        <th>N¬∫</th>
                        <th>Patrim√¥nio</th>
                        <th>Ferramenta</th>
                        <th>Status</th>
                        <th>Custo Conserto (R$)</th>
                        <th>Pre√ßo Novo (R$)</th>
                        <th>Economia (R$)</th>
                        <th>Economia %</th>
                        <th>Decis√£o</th>
                    </tr>
                </thead>
                <tbody id="tabelaBody">
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="fas fa-cloud"></i>
                            <br>
                            Carregando dados do Supabase...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO SUPABASE
        // ============================================
        const SUPABASE_CONFIG = {
            url: 'https://eokhafnfmynhridksnuh.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVva2hhZm5mbXluaHJpZGtzbnVoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxMzYwMDIsImV4cCI6MjA4NTcxMjAwMn0.-RZtzUYpdOI4_WKOmP9lqw9guJmvh8XFeAL6UXhA4vo'
        };

        // ============================================
        // DADOS GLOBAIS (MANTIDO IGUAL)
        // ============================================
        let ferramentas = [];
        let categorias = [];
        let custosConserto = {};
        let precosNovo = {};
        let selectedItems = new Set();
        let visualizacaoAtual = 'todos';
        const LIMIAR_VIABILIDADE = 0.4; // 40%

        // ============================================
        // FUN√á√ïES AUXILIARES (MANTIDAS)
        // ============================================
        function formatarValorBR(valor) {
            if (valor === undefined || valor === null) return '0,00';
            return valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function formatarDataBR(data) {
            const dia = String(data.getDate()).padStart(2, '0');
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const ano = data.getFullYear();
            return `${dia}/${mes}/${ano}`;
        }

        function converterParaNumero(valor) {
            if (typeof valor === 'number') return valor;
            if (!valor) return 0;

            let valorStr = String(valor).trim();
            valorStr = valorStr.replace(/[Rr]\$\s*/g, '');

            if (valorStr.includes(',') && !valorStr.includes('.')) {
                valorStr = valorStr.replace(/\./g, '');
                valorStr = valorStr.replace(',', '.');
            } else if (valorStr.includes(',') && valorStr.includes('.')) {
                const ultimaVirgula = valorStr.lastIndexOf(',');
                const ultimoPonto = valorStr.lastIndexOf('.');

                if (ultimoPonto > ultimaVirgula) {
                    valorStr = valorStr.replace(/,/g, '');
                } else {
                    valorStr = valorStr.replace(/\./g, '');
                    valorStr = valorStr.replace(',', '.');
                }
            }

            const num = parseFloat(valorStr);
            return isNaN(num) ? 0 : num;
        }

        // ============================================
        // NOVA L√ìGICA: DECIS√ÉO BASEADA EM 40%
        // ============================================
        function calcularDecisao(custoConserto, precoNovo) {
            if (custoConserto <= 0 || precoNovo <= 0) return 'A DEFINIR';

            const percentualCusto = custoConserto / precoNovo;

            if (percentualCusto <= LIMIAR_VIABILIDADE) {
                return 'CONSERTAR';
            } else {
                return 'COMP.NOVO';
            }
        }

        function calcularEconomiaPercentual(custoConserto, precoNovo) {
            if (custoConserto <= 0 || precoNovo <= 0) return 0;
            return ((precoNovo - custoConserto) / precoNovo) * 100;
        }

        // ============================================
        // BUSCAR DADOS DO SUPABASE (MANTIDO)
        // ============================================
        async function buscarDoSupabase() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingMessage').innerHTML = 'Conectando ao Supabase...';
            document.getElementById('infoMessage').innerHTML = 'Conectando ao Supabase...';
            document.getElementById('infoIcon').className = 'fas fa-cloud';

            try {
                const url = `${SUPABASE_CONFIG.url}/rest/v1/tools?select=*`;

                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_CONFIG.key,
                        'Authorization': `Bearer ${SUPABASE_CONFIG.key}`,
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }

                const dados = await response.json();

                if (dados && dados.length > 0) {
                    processarDadosSupabase(dados);
                    document.getElementById('infoMessage').innerHTML = 'Dados carregados do Supabase (online)';
                } else {
                    throw new Error('Nenhum dado encontrado');
                }

            } catch (error) {
                console.error('Erro ao buscar do Supabase:', error);
                document.getElementById('infoMessage').innerHTML = 'Erro ao conectar. Use "Importar CSV" para dados offline.';
                document.getElementById('infoIcon').className = 'fas fa-exclamation-triangle';

                criarDadosExemplo();
                alert('Erro ao conectar ao Supabase. Dados de exemplo foram carregados para teste.');

            } finally {
                document.getElementById('loading').classList.remove('active');
            }
        }

        // ============================================
        // DADOS DE EXEMPLO (COM OS MESMOS DA PLANILHA)
        // ============================================
        function criarDadosExemplo() {
            ferramentas = [
                { id: 1, patrimonio: '1823', nome: 'Esmerilhadeira Angular 2200W MAKITA 9"', categoria: 'Ferramentas El√©tricas', status: 'Dispon√≠vel', valor_compra: 800 },
                { id: 2, patrimonio: '1824-C', nome: 'Carregador GAL 1880 CV', categoria: 'Ferramentas El√©tricas', status: 'Dispon√≠vel', valor_compra: 200 },
                { id: 3, patrimonio: 'PAT-003', nome: 'Serra Circular Makita', categoria: 'Ferramentas El√©tricas', status: 'Danificado', valor_compra: 890 },
                { id: 4, patrimonio: 'PAT-004', nome: 'Martelo 500g', categoria: 'Ferramentas Manuais', status: 'Bom', valor_compra: 35 }
            ];

            categorias = [...new Set(ferramentas.map(f => f.categoria))];

            precosNovo = {
                1: 800,
                2: 200,
                3: 890,
                4: 35
            };

            custosConserto = {
                1: 100,
                2: 210,
                3: 350,
                4: 0
            };

            atualizarFiltrosCategoria();
            aplicarFiltros();
            selecionarTodos();
        }

        // ============================================
        // PROCESSAR DADOS DO SUPABASE
        // ============================================
        function processarDadosSupabase(dados) {
            ferramentas = dados.map(tool => ({
                id: tool.id,
                patrimonio: tool.patrimonio || tool.code || `ID-${tool.id}`,
                nome: tool.name || tool.nome || 'Sem nome',
                categoria: tool.category || tool.categoria || 'Geral',
                status: tool.status || 'Dispon√≠vel',
                valor_compra: tool.preco || tool.valor_compra || 0
            }));

            categorias = [...new Set(ferramentas.map(f => f.categoria))];

            ferramentas.forEach(f => {
                if (f.valor_compra > 0) {
                    precosNovo[f.id] = f.valor_compra;
                }
            });

            atualizarFiltrosCategoria();
            aplicarFiltros();
        }

        // ============================================
        // FUN√á√ïES DA INTERFACE (TODAS MANTIDAS)
        // ============================================
        function recarregarDoSupabase() {
            buscarDoSupabase();
        }

        function alternarVisualizacao(tipo) {
            visualizacaoAtual = tipo;

            document.getElementById('viewAllBtn').classList.toggle('active', tipo === 'todos');
            document.getElementById('viewSelectedBtn').classList.toggle('active', tipo === 'selecionados');

            aplicarFiltros();
        }

        function importarArquivo(input) {
            if (!input.files || !input.files[0]) {
                alert('Selecione um arquivo para importar');
                return;
            }

            const file = input.files[0];

            const reader = new FileReader();

            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingMessage').innerHTML = `Processando ${file.name}...`;
            document.getElementById('infoMessage').innerHTML = `Dados carregados do arquivo: ${file.name} (offline)`;
            document.getElementById('infoIcon').className = 'fas fa-file-import';

            reader.onload = function (e) {
                try {
                    const data = e.target.result;
                    const linhas = data.split('\n').map(l => l.trim()).filter(l => l.length > 0);

                    if (linhas.length < 2) throw new Error('Arquivo vazio');

                    ferramentas = [];
                    custosConserto = {};
                    precosNovo = {};

                    for (let i = 1; i < linhas.length; i++) {
                        const cols = linhas[i].split(',').map(c => c.trim().replace(/"/g, ''));
                        if (cols.length < 5) continue;

                        const id = i;
                        ferramentas.push({
                            id: id,
                            patrimonio: cols[1] || `ID-${id}`,
                            nome: cols[2] || 'Sem nome',
                            categoria: 'Geral',
                            status: cols[3] || 'Dispon√≠vel',
                            valor_compra: parseFloat(cols[6]) || 0
                        });

                        if (cols[5]) custosConserto[id] = parseFloat(cols[5]) || 0;
                        if (cols[6]) precosNovo[id] = parseFloat(cols[6]) || 0;
                    }

                    categorias = [...new Set(ferramentas.map(f => f.categoria))];
                    atualizarFiltrosCategoria();
                    aplicarFiltros();
                    selecionarTodos();

                    document.getElementById('loading').classList.remove('active');
                    alert(`${ferramentas.length} ferramentas importadas!`);

                } catch (error) {
                    console.error('Erro:', error);
                    alert('Erro ao processar arquivo');
                    document.getElementById('loading').classList.remove('active');
                }
            };

            reader.readAsText(file, 'UTF-8');
        }

        function atualizarFiltrosCategoria() {
            const catSelect = document.getElementById('categoriaFilter');
            catSelect.innerHTML = '<option value="todos">Todas as Categorias</option>';
            categorias.sort().forEach(cat => {
                catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
        }

        function aplicarFiltros() {
            const status = document.getElementById('statusFilter').value;
            const categoria = document.getElementById('categoriaFilter').value;
            const busca = document.getElementById('searchFilter').value.toLowerCase();

            let filtradas = ferramentas.filter(f => {
                if (status !== 'todos') {
                    const statusFerramenta = f.status ? f.status.toLowerCase() : '';
                    const statusFiltro = status.toLowerCase();

                    if (statusFiltro === 'manuten√ß√£o' && !statusFerramenta.includes('manuten')) return false;
                    else if (statusFiltro === 'danificado' && !statusFerramenta.includes('danific')) return false;
                    else if (statusFiltro === 'dispon√≠vel' && !statusFerramenta.includes('dispon')) return false;
                    else if (statusFiltro === 'bom' && !statusFerramenta.includes('bom')) return false;
                    else if (statusFiltro === 'reservado' && !statusFerramenta.includes('reserv')) return false;
                }

                if (categoria !== 'todos' && f.categoria !== categoria) return false;

                if (busca) {
                    const nomeMatch = f.nome ? f.nome.toLowerCase().includes(busca) : false;
                    const patrimMatch = f.patrimonio ? f.patrimonio.toLowerCase().includes(busca) : false;
                    if (!nomeMatch && !patrimMatch) return false;
                }

                return true;
            });

            if (visualizacaoAtual === 'selecionados') {
                filtradas = filtradas.filter(f => selectedItems.has(f.id));
            }

            atualizarTabela(filtradas);
            atualizarCards();
            atualizarResumoSelecao();
        }

        function atualizarTabela(ferramentasFiltradas) {
            const tbody = document.getElementById('tabelaBody');

            if (ferramentasFiltradas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="empty-state">
                            <i class="fas fa-search"></i>
                            <br>
                            Nenhuma ferramenta encontrada
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';

            ferramentasFiltradas.forEach((ferramenta, index) => {
                const custoConserto = custosConserto[ferramenta.id] || 0;
                const valorNovo = precosNovo[ferramenta.id] || 0;

                let diferenca = valorNovo - custoConserto;
                let economiaPercentual = calcularEconomiaPercentual(custoConserto, valorNovo);
                let decisao = calcularDecisao(custoConserto, valorNovo);

                const selectedClass = selectedItems.has(ferramenta.id) ? 'selected' : '';

                let statusClass = '';
                const statusLower = ferramenta.status ? ferramenta.status.toLowerCase() : '';

                if (statusLower.includes('danific')) {
                    statusClass = 'Danificado';
                } else if (statusLower.includes('manuten')) {
                    statusClass = 'Manuten√ß√£o';
                } else if (statusLower.includes('dispon')) {
                    statusClass = 'Dispon√≠vel';
                } else if (statusLower.includes('bom')) {
                    statusClass = 'Bom';
                } else if (statusLower.includes('reserv')) {
                    statusClass = 'Reservado';
                } else {
                    statusClass = 'Dispon√≠vel';
                }

                html += `
                    <tr class="${selectedClass}">
                        <td class="checkbox-cell">
                            <input type="checkbox" 
                                   ${selectedItems.has(ferramenta.id) ? 'checked' : ''}
                                   onchange="toggleItemSelection(${ferramenta.id}, this.checked)">
                        </td>
                        <td>${index + 1}</td>
                        <td><strong>${ferramenta.patrimonio}</strong></td>
                        <td>${ferramenta.nome}</td>
                        <td>
                            <span class="status-badge status-${statusClass}">
                                ${ferramenta.status}
                            </span>
                        </td>
                        <td>
                            <input type="text" class="valor-input" 
                                   value="${custoConserto > 0 ? custoConserto.toFixed(2).replace('.', ',') : ''}"
                                   onchange="atualizarCustoConserto(${ferramenta.id}, this.value)"
                                   placeholder="0,00">
                        </td>
                        <td>
                            <input type="text" class="valor-input" 
                                   value="${valorNovo > 0 ? valorNovo.toFixed(2).replace('.', ',') : ''}"
                                   onchange="atualizarPrecoNovo(${ferramenta.id}, this.value)"
                                   placeholder="0,00">
                        </td>
                        <td style="color: ${diferenca > 0 ? '#34d399' : '#f87171'}; font-weight: bold;">
                            R$ ${formatarValorBR(Math.abs(diferenca))}
                        </td>
                        <td style="color: ${economiaPercentual > 0 ? '#34d399' : '#f87171'};">
                            ${economiaPercentual.toFixed(1).replace('.', ',')}%
                        </td>
                        <td>
                            <span class="decision-badge decision-${decisao === 'CONSERTAR' ? 'repair' : 'buy'}">
                                ${decisao}
                            </span>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        function atualizarCards() {
            const itensSelecionados = ferramentas.filter(f => selectedItems.has(f.id));

            let totalConserto = 0;
            let totalNovo = 0;

            itensSelecionados.forEach(f => {
                totalConserto += custosConserto[f.id] || 0;
                totalNovo += precosNovo[f.id] || 0;
            });

            const economiaTotal = totalNovo - totalConserto;

            const cardsHtml = `
                <div class="card total">
                    <h3>Total Ferramentas Selecionadas</h3>
                    <div class="value">${itensSelecionados.length}</div>
                    <div class="subtitle">itens selecionados</div>
                </div>
                <div class="card repair">
                    <h3>Custo Total Conserto</h3>
                    <div class="value">R$ ${formatarValorBR(totalConserto)}</div>
                    <div class="subtitle">valores digitados</div>
                </div>
                <div class="card buy">
                    <h3>Custo Total Novo</h3>
                    <div class="value">R$ ${formatarValorBR(totalNovo)}</div>
                    <div class="subtitle">valores digitados</div>
                </div>
                <div class="card savings">
                    <h3>Economia Potencial</h3>
                    <div class="value">R$ ${formatarValorBR(economiaTotal)}</div>
                    <div class="subtitle">optando por consertar</div>
                </div>
            `;

            document.getElementById('summaryCards').innerHTML = cardsHtml;
        }

        function toggleItemSelection(id, checked) {
            if (checked) selectedItems.add(id);
            else selectedItems.delete(id);
            atualizarResumoSelecao();
            aplicarFiltros();
        }

        function selecionarTodos() {
            ferramentas.forEach(f => selectedItems.add(f.id));
            aplicarFiltros();
        }

        function limparSelecao() {
            selectedItems.clear();
            aplicarFiltros();
        }

        function toggleAllCheckboxes(checkbox) {
            if (checkbox.checked) {
                ferramentas.forEach(f => selectedItems.add(f.id));
            } else {
                selectedItems.clear();
            }
            aplicarFiltros();
        }

        function atualizarResumoSelecao() {
            const selecionados = ferramentas.filter(f => selectedItems.has(f.id));
            const totalSelecionado = selecionados.reduce((acc, f) => acc + (f.valor_compra || 0), 0);

            document.getElementById('selectedCount').innerHTML = selecionados.length;
            document.getElementById('selectedTotal').innerHTML = formatarValorBR(totalSelecionado);
        }

        function atualizarCustoConserto(id, valor) {
            custosConserto[id] = converterParaNumero(valor);
            aplicarFiltros();
        }

        function atualizarPrecoNovo(id, valor) {
            precosNovo[id] = converterParaNumero(valor);
            aplicarFiltros();
        }

        // ============================================
        // GERAR EXCEL USANDO SEU ARQUIVO COMO TEMPLATE
        // ============================================
        async function gerarExcelComparativo() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('loadingMessage').innerHTML = 'Gerando arquivo Excel...';

            try {
                const selecionados = ferramentas.filter(f => selectedItems.has(f.id));

                if (selecionados.length === 0) {
                    alert('Selecione pelo menos um item para exportar');
                    document.getElementById('loading').classList.remove('active');
                    return;
                }

                // ============================================
                // 1. CARREGAR SEU ARQUIVO BASE
                // ============================================
                const response = await fetch('Analise Comparativa (Base).xlsx');
                const templateBuffer = await response.arrayBuffer();

                // 2. ABRIR O WORKBOOK
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(templateBuffer);

                // 3. PEGAR A PLANILHA
                const worksheet = workbook.getWorksheet('Planilha1');

                if (!worksheet) {
                    throw new Error('Planilha "Planilha1" n√£o encontrada');
                }

                // 4. CALCULAR OS NOVOS VALORES
                let totalCustoConserto = 0;
                let totalCustoNovo = 0;

                selecionados.forEach(item => {
                    totalCustoConserto += custosConserto[item.id] || 0;
                    totalCustoNovo += precosNovo[item.id] || 0;
                });

                const economiaTotal = totalCustoNovo - totalCustoConserto;

                // Data atual (formato YYYY-MM-DD HH:MM:SS igual ao template)
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const dia = String(hoje.getDate()).padStart(2, '0');
                const dataFormatada = `${ano}-${mes}-${dia} 00:00:00`;

                // N√∫mero do documento (formato AC-ANO-N√öMERO)
                const numDocumento = `AC-${ano}-${Math.floor(Math.random() * 900000 + 100000)}`;

                // ============================================
                // 5. ATUALIZAR VALORES NAS C√âLULAS CORRETAS
                // ============================================

                // LINHA 2
                worksheet.getCell('B2').value = numDocumento;     // N¬∫ do documento
                worksheet.getCell('G2').value = dataFormatada;    // DATA

                // LINHA 5 - TOTAIS
                worksheet.getCell('B5').value = selecionados.length; // Quantidade
                worksheet.getCell('C5').value = totalCustoConserto;  // Total conserto
                worksheet.getCell('D5').value = totalCustoNovo;      // Total novo
                worksheet.getCell('G5').value = economiaTotal;       // Economia

                // ============================================
                // 6. LIMPAR DADOS DE EXEMPLO (LINHAS 9 E 10)
                // ============================================
                // Manter a formata√ß√£o, s√≥ apagar os valores
                for (let c = 1; c <= 8; c++) {
                    worksheet.getCell(9, c).value = null;
                    worksheet.getCell(10, c).value = null;
                    worksheet.getCell(11, c).value = null;
                    worksheet.getCell(12, c).value = null;
                    worksheet.getCell(13, c).value = null;
                    worksheet.getCell(14, c).value = null;
                    worksheet.getCell(15, c).value = null;
                    worksheet.getCell(16, c).value = null;
                    worksheet.getCell(17, c).value = null;
                    worksheet.getCell(18, c).value = null;
                    worksheet.getCell(19, c).value = null;
                    worksheet.getCell(20, c).value = null;
                    worksheet.getCell(21, c).value = null;
                    worksheet.getCell(22, c).value = null;
                    worksheet.getCell(23, c).value = null;
                    worksheet.getCell(24, c).value = null;
                    worksheet.getCell(25, c).value = null;
                    worksheet.getCell(26, c).value = null;
                    worksheet.getCell(27, c).value = null;
                    worksheet.getCell(28, c).value = null;
                    worksheet.getCell(29, c).value = null;
                    worksheet.getCell(30, c).value = null;
                    worksheet.getCell(31, c).value = null;
                    worksheet.getCell(32, c).value = null;
                    worksheet.getCell(33, c).value = null;
                    worksheet.getCell(34, c).value = null;
                    worksheet.getCell(35, c).value = null;
                    worksheet.getCell(36, c).value = null;
                    worksheet.getCell(37, c).value = null;
                    worksheet.getCell(38, c).value = null;
                    worksheet.getCell(39, c).value = null;                                                                                
                }

                // ============================================
                // 7. INSERIR NOVOS DADOS A PARTIR DA LINHA 9
                // ============================================
                selecionados.forEach((item, index) => {
                    const rowNum = 9 + index; // 9, 10, 11, 12...
                    const custoConserto = custosConserto[item.id] || 0;
                    const precoNovo = precosNovo[item.id] || 0;

                    // Calcular economia percentual (decimal, igual ao template: 0.875 ou -0.1)
                    const economiaPercentual = precoNovo > 0 ? (precoNovo - custoConserto) / precoNovo : 0;

                    const decisao = calcularDecisao(custoConserto, precoNovo);

                    // Status (manter como est√°, se for "Dispon√≠vel" vira "Disp.")
                    let statusDisplay = item.status;
                    if (statusDisplay && statusDisplay.toLowerCase().includes('dispon')) {
                        statusDisplay = 'Disp.';
                    }

                    // Coluna A: N¬∫
                    worksheet.getCell(rowNum, 1).value = index + 1;

                    // Coluna B: N¬∫ PATR.
                    worksheet.getCell(rowNum, 2).value = item.patrimonio;

                    // Coluna C: DESCRI√á√ÉO
                    worksheet.getCell(rowNum, 3).value = item.nome;

                    // Coluna D: STATUS
                    worksheet.getCell(rowNum, 4).value = statusDisplay;

                    // Coluna E: CUST. MANUT
                    worksheet.getCell(rowNum, 5).value = custoConserto;

                    // Coluna F: NOVO
                    worksheet.getCell(rowNum, 6).value = precoNovo;

                    // Coluna G: ECON. EM %
                    worksheet.getCell(rowNum, 7).value = economiaPercentual;

                    // Coluna H: DECIS.
                    worksheet.getCell(rowNum, 8).value = decisao;
                });

                // ============================================
                // 8. GERAR O ARQUIVO
                // ============================================
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analise_comparativa_${dia}-${mes}-${ano}.xlsx`;
                a.click();
                window.URL.revokeObjectURL(url);

                document.getElementById('loading').classList.remove('active');
                alert('Arquivo Excel gerado com sucesso!');

            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('loading').classList.remove('active');
                alert('Erro ao gerar Excel: ' + error.message);
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('statusFilter').addEventListener('change', aplicarFiltros);
        document.getElementById('categoriaFilter').addEventListener('change', aplicarFiltros);
        document.getElementById('searchFilter').addEventListener('keyup', aplicarFiltros);

        // INICIALIZA√á√ÉO
        window.addEventListener('load', function () {
            buscarDoSupabase();
        });
    </script>
</body>

</html>
